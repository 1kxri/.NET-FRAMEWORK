using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.IO;

namespace LAB_10.NET
{
    public partial class Form1 : Form
    {
        private readonly Dictionary<string, int> _phoneTemplates = new Dictionary<string, int>()
        {
            { "+7", 10 },    // Россия / Казахстан — 10 цифр после +7
            { "+1", 10 },    // США/Канада — 10 цифр
            { "+375", 9 },   // Беларусь — 9 цифр
            { "+49", 10 },   // Германия — часто 10 
            { "+33", 9 },    // Франция — 9
            { "+44", 10 }    // Великобритания — 10
        };

        public Form1()
        {
            InitializeComponent();
        }

        private string GetSelectedCountryCode() 
        { if (comboBox4.SelectedItem == null) 
                return null; 
            string s = comboBox4.SelectedItem.ToString(); 
            int spaceIndex = s.IndexOf(' '); 
            if (spaceIndex > 0) 
                return s.Substring(0, spaceIndex); 
            return s; 
        }

        private class Employee
        {
            private string _fio;
            public string FIO
            {
                get => _fio;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("ФИО не может быть пустым.");
                    _fio = value.Trim();
                }
            }

            private string _faculty;
            public string Faculty
            {
                get => _faculty;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Выберите факультет.");
                    _faculty = value;
                }
            }

            private string _position;
            public string Position
            {
                get => _position;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Выберите должность.");
                    _position = value;
                }
            }

            private string _gender;
            public string Gender
            {
                get => _gender;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Выберите пол.");
                    _gender = value;
                }
            }

            private DateTime _birthDate;
            public DateTime BirthDate
            {
                get => _birthDate;
                set
                {
                    DateTime minDate = new DateTime(1908, 6, 8);
                    DateTime maxDate = DateTime.Today;

                    if (value < minDate)
                        throw new Exception($"Дата рождения не может быть раньше {minDate:dd.MM.yyyy}.");
                    if (value > maxDate)
                        throw new Exception("Дата рождения не может быть из будущего.");

                    _birthDate = value;
                }
            }

            private string _email;
            public string Email
            {
                get => _email;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Email не может быть пустым.");
                    if (!value.All(ch =>
                        (ch >= 'a' && ch <= 'z') ||
                        (ch >= 'A' && ch <= 'Z') ||
                        char.IsDigit(ch) ||
                        ch == '@' || ch == '.' || ch == '-' || ch == '_'))
                        throw new Exception("Email должен содержать только латинские буквы, цифры и символы . _ - @");

                    var parts = value.Split('@');
                    if (parts.Length != 2)
                        throw new Exception("Email должен содержать один символ '@'");
                    if (string.IsNullOrWhiteSpace(parts[0]))
                        throw new Exception("Email должен быть в формате имя@домен.зона");
                    if (!parts[1].Contains("."))
                        throw new Exception("После '@' должны быть домен и доменная зона");

                    _email = value.Trim();
                }
            }

            private string _phone; 
            public string Phone 
            { get => _phone; 
                set { 
                    if (string.IsNullOrWhiteSpace(value)) 
                        throw new Exception("Телефон не может быть пустым.");
                    string phone = value.Trim();
                    _phone = phone; } 
            }

            private string _login;
            public string Login
            {
                get => _login;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Логин не может быть пустым.");
                    _login = value.Trim();
                }
            }

            private string _password;
            public string Password
            {
                get => _password;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Пароль не может быть пустым.");
                    if (value.Length < 8)
                        throw new Exception("Пароль должен содержать минимум 8 символов.");
                    if (!value.Any(char.IsDigit))
                        throw new Exception("Пароль должен содержать хотя бы одну цифру.");
                    if (!value.Any(char.IsUpper))
                        throw new Exception("Пароль должен содержать хотя бы одну заглавную букву.");
                    if (!value.Any(ch => "!@#$%^&*()_-+=[]{}:;?,.<>/|`~".Contains(ch)))
                        throw new Exception("Пароль должен содержать хотя бы один специальный символ.");
                    if (value.Contains(" "))
                        throw new Exception("Пароль не должен содержать пробелы.");

                    _password = value;
                }
            }

            private string _authCode;
            public string AuthCode
            {
                get => _authCode;
                set
                {
                    if (string.IsNullOrWhiteSpace(value))
                        throw new Exception("Код авторизации не может быть пустым.");

                    if (value.Contains(" "))
                        throw new Exception("Код авторизации не должен содержать пробелы.");

                    _authCode = value.Trim();
                }
            }

            public void SaveToFile(string folderPath)
            {
                if (!Directory.Exists(folderPath))
                    Directory.CreateDirectory(folderPath);

                string filePath = Path.Combine(folderPath, $"{Login}.txt");

                using (StreamWriter sw = new StreamWriter(filePath))
                {
                    sw.WriteLine($"ФИО={FIO}");
                    sw.WriteLine($"Факультет={Faculty}");
                    sw.WriteLine($"Должность={Position}");
                    sw.WriteLine($"Пол={Gender}");
                    sw.WriteLine($"ДатаРождения={BirthDate:yyyy-MM-dd}");
                    sw.WriteLine($"Email={Email}");
                    sw.WriteLine($"Телефон={Phone}");
                    sw.WriteLine($"Логин={Login}");
                    sw.WriteLine($"Пароль={Password}");
                    sw.WriteLine($"КодАвторизации={AuthCode}");
                }
            }

            public bool CheckLoginPassword(string login, string password)
            {
                return Login == login && Password == password;
            }

            public bool CheckAuthCode(string code)
            {
                return AuthCode == code;
            }

            public static Employee LoadFromFile(string filePath)
            {
                if (!File.Exists(filePath))
                    return null;

                string[] lines = File.ReadAllLines(filePath);

                return new Employee
                {
                    FIO = lines.First(l => l.StartsWith("ФИО=")).Split('=')[1],
                    Faculty = lines.First(l => l.StartsWith("Факультет=")).Split('=')[1],
                    Position = lines.First(l => l.StartsWith("Должность=")).Split('=')[1],
                    Gender = lines.First(l => l.StartsWith("Пол=")).Split('=')[1],
                    BirthDate = DateTime.Parse(lines.First(l => l.StartsWith("ДатаРождения=")).Split('=')[1]),
                    Email = lines.First(l => l.StartsWith("Email=")).Split('=')[1],
                    Phone = lines.First(l => l.StartsWith("Телефон=")).Split('=')[1],
                    Login = lines.First(l => l.StartsWith("Логин=")).Split('=')[1],
                    Password = lines.First(l => l.StartsWith("Пароль=")).Split('=')[1],
                    AuthCode = lines.First(l => l.StartsWith("КодАвторизации=")).Split('=')[1]
                };
            }
        }

        private string GetEmployeesFolderPath()
        {
            string projectRoot = Directory.GetParent(Application.StartupPath).Parent.Parent.FullName;
            return Path.Combine(projectRoot, "employees");
        }

        private void button1_Click(object sender, EventArgs e)
        {
            textBox8.Clear();
            try
            {
                Employee emp = new Employee();
                emp.FIO = textBox1.Text;
                emp.Faculty = comboBox1.SelectedItem?.ToString();
                emp.Position = comboBox2.SelectedItem?.ToString();
                emp.Gender = comboBox3.SelectedItem?.ToString();

                if (!DateTime.TryParse(textBox2.Text.Trim(), out DateTime birth))
                    throw new Exception("Дата рождения введена неверно. Ожидается формат даты по примеру: 21.05.2006");
                emp.BirthDate = birth;

                emp.Email = textBox3.Text;

                string countryCode = GetSelectedCountryCode(); 
                if (string.IsNullOrWhiteSpace(countryCode)) 
                    throw new Exception("Выберите страну в поле телефон."); 
                if (!_phoneTemplates.ContainsKey(countryCode)) 
                    throw new Exception("Шаблон телефона для выбранной страны не настроен."); 
                string secondPart = textBox4.Text?.Trim() ?? ""; 
                if (!secondPart.All(char.IsDigit)) 
                    throw new Exception("Вторую часть телефона должны составлять только цифры."); 
                int requiredLen = _phoneTemplates[countryCode]; 
                if (secondPart.Length != requiredLen) 
                    throw new Exception($"Для кода {countryCode} ожидается ровно {requiredLen} цифр во второй части номера."); 
                emp.Phone = countryCode + secondPart;

                emp.Login = textBox5.Text;
                emp.Password = textBox6.Text;
                emp.AuthCode = textBox7.Text;

                string folderPath = GetEmployeesFolderPath();

                if (!Directory.Exists(folderPath))
                    Directory.CreateDirectory(folderPath);

                foreach (string file in Directory.GetFiles(folderPath, "*.txt"))
                {
                    string[] lines = File.ReadAllLines(file);
                    string savedLogin = lines.FirstOrDefault(l => l.StartsWith("Логин="))?.Split('=')[1].Trim();
                    string savedCode = lines.FirstOrDefault(l => l.StartsWith("КодАвторизации="))?.Split('=')[1].Trim();
                    if (savedLogin == emp.Login)
                        throw new Exception("Пользователь с таким логином уже зарегистрирован.");
                    if (savedCode == emp.AuthCode)
                        throw new Exception("Такой код авторизации уже существует. Введите другой.");
                }

                emp.SaveToFile(folderPath);
                textBox8.Text = $"Пользователь {emp.FIO} успешно зарегистрирован.\r\nФайл создан: {Path.Combine(folderPath, emp.Login + ".txt")}";
            }
            catch (Exception ex)
            {
                textBox8.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button2_Click(object sender, EventArgs e)
        {
            textBox11.Clear();
            try
            {
                string login = textBox9.Text.Trim();
                string password = textBox10.Text;

                if (string.IsNullOrWhiteSpace(login))
                    throw new Exception("Логин не может быть пустым.");
                if (string.IsNullOrWhiteSpace(password))
                    throw new Exception("Пароль не может быть пустым.");

                string folderPath = GetEmployeesFolderPath();
                string filePath = Path.Combine(folderPath, $"{login}.txt");

                if (!File.Exists(filePath))
                    throw new Exception("Пользователь с таким логином не найден.");

                Employee user = Employee.LoadFromFile(filePath);

                if (user.Password != password)
                    throw new Exception("Неверный пароль.");

                textBox11.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\n\nДанные пользователя:\r\n" +
                                $"ФИО: {user.FIO}\r\n" +
                                $"Факультет: {user.Faculty}\r\n" +
                                $"Должность: {user.Position}\r\n" +
                                $"Пол: {user.Gender}\r\n" +
                                $"Дата рождения: {user.BirthDate:yyyy-MM-dd}\r\n" +
                                $"Email: {user.Email}\r\n" +
                                $"Телефон: {user.Phone}\r\n" +
                                $"Логин: {user.Login}\r\n" +
                                $"Код авторизации: {user.AuthCode}";
            }
            catch (Exception ex)
            {
                textBox11.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            textBox12.Clear();
            try
            {
                string code = textBox14.Text.Trim();
                if (string.IsNullOrWhiteSpace(code))
                    throw new Exception("Код авторизации не может быть пустым.");

                string folderPath = GetEmployeesFolderPath();
                bool found = false;

                foreach (string file in Directory.GetFiles(folderPath, "*.txt"))
                {
                    Employee user = Employee.LoadFromFile(file);
                    if (user.CheckAuthCode(code))
                    {
                        textBox12.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\n\nДанные пользователя:\r\n" +
                                        $"ФИО: {user.FIO}\r\n" +
                                        $"Факультет: {user.Faculty}\r\n" +
                                        $"Должность: {user.Position}\r\n" +
                                        $"Пол: {user.Gender}\r\n" +
                                        $"Дата рождения: {user.BirthDate:yyyy-MM-dd}\r\n" +
                                        $"Email: {user.Email}\r\n" +
                                        $"Телефон: {user.Phone}\r\n" +
                                        $"Логин: {user.Login}\r\n" +
                                        $"Код авторизации: {user.AuthCode}";
                        found = true;
                        break;
                    }
                }

                if (!found)
                    throw new Exception("Код авторизации не найден.");
            }
            catch (Exception ex)
            {
                textBox12.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            OpenFileDialog ofd = new OpenFileDialog();
            ofd.Filter = "Текстовые файлы (*.txt)|*.txt|Все файлы (*.*)|*.*";

            if (ofd.ShowDialog() == DialogResult.OK)
            {
                textBox15.Text = ofd.FileName;
            }
        }

        private void button5_Click(object sender, EventArgs e)
        {
            textBox13.Clear();
            try
            {
                string keyFilePath = textBox15.Text.Trim();
                if (string.IsNullOrWhiteSpace(keyFilePath))
                    throw new Exception("Файл ключа не выбран.");
                if (!File.Exists(keyFilePath))
                    throw new Exception("Файл ключа не найден.");

                string codeLine = File.ReadAllLines(keyFilePath).FirstOrDefault(l => l.StartsWith("КодАвторизации="));
                if (codeLine == null)
                    throw new Exception("В выбранном файле не найден код авторизации.");

                string code = codeLine.Split('=')[1].Trim();

                string folderPath = GetEmployeesFolderPath();
                bool found = false;
                foreach (string file in Directory.GetFiles(folderPath, "*.txt"))
                {
                    Employee user = Employee.LoadFromFile(file);
                    if (user.CheckAuthCode(code))
                    {
                        textBox13.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\n\nДанные пользователя:\r\n" +
                                        $"ФИО: {user.FIO}\r\n" +
                                        $"Факультет: {user.Faculty}\r\n" +
                                        $"Должность: {user.Position}\r\n" +
                                        $"Пол: {user.Gender}\r\n" +
                                        $"Дата рождения: {user.BirthDate:yyyy-MM-dd}\r\n" +
                                        $"Email: {user.Email}\r\n" +
                                        $"Телефон: {user.Phone}\r\n" +
                                        $"Логин: {user.Login}\r\n" +
                                        $"Код авторизации: {user.AuthCode}";
                        found = true;
                        break;
                    }
                }

                if (!found)
                    throw new Exception("Код авторизации из файла не найден.");
            }
            catch (Exception ex)
            {
                textBox13.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button6_Click(object sender, EventArgs e)
        {
            textBox16.Clear();

            try
            {
                string login = textBox18.Text.Trim();
                string password = textBox17.Text;

                if (string.IsNullOrWhiteSpace(login))
                    throw new Exception("Логин не может быть пустым.");
                if (string.IsNullOrWhiteSpace(password))
                    throw new Exception("Пароль не может быть пустым.");

                string appRootPath = Directory.GetParent(Application.StartupPath).Parent.Parent.FullName;
                string employeesFolder = Path.Combine(appRootPath, "employees");
                string filePath = Path.Combine(employeesFolder, $"{login}.txt");

                if (!File.Exists(filePath))
                    throw new Exception("Пользователь с таким логином не найден.");

                string[] lines = File.ReadAllLines(filePath);
                string savedPassword = lines.FirstOrDefault(l => l.StartsWith("Пароль="))?.Split('=')[1];

                if (savedPassword != password)
                    throw new Exception("Неверный пароль.");

                Employee user = new Employee
                {
                    FIO = lines.First(l => l.StartsWith("ФИО=")).Split('=')[1],
                    Faculty = lines.First(l => l.StartsWith("Факультет=")).Split('=')[1],
                    Position = lines.First(l => l.StartsWith("Должность=")).Split('=')[1],
                    Gender = lines.First(l => l.StartsWith("Пол=")).Split('=')[1],
                    BirthDate = DateTime.Parse(lines.First(l => l.StartsWith("ДатаРождения=")).Split('=')[1]),
                    Email = lines.First(l => l.StartsWith("Email=")).Split('=')[1],
                    Phone = lines.First(l => l.StartsWith("Телефон=")).Split('=')[1],
                    Login = login,
                    Password = password,
                    AuthCode = lines.First(l => l.StartsWith("КодАвторизации=")).Split('=')[1]
                };

                textBox16.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\nДанные пользователя:\r\n" +
                                string.Join("\r\n", lines);
            }
            catch (Exception ex)
            {
                textBox16.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button7_Click(object sender, EventArgs e)
        {
            textBox20.Clear();

            try
            {
                string code = textBox19.Text.Trim();
                if (string.IsNullOrWhiteSpace(code))
                    throw new Exception("Код авторизации не может быть пустым.");

                string appRootPath = Directory.GetParent(Application.StartupPath).Parent.Parent.FullName;
                string employeesFolder = Path.Combine(appRootPath, "employees");

                bool found = false;
                Employee user = null;

                foreach (string file in Directory.GetFiles(employeesFolder, "*.txt"))
                {
                    string[] lines = File.ReadAllLines(file);
                    string savedCode = lines.FirstOrDefault(l => l.StartsWith("КодАвторизации="))?.Split('=')[1];

                    if (savedCode == code)
                    {
                        user = new Employee
                        {
                            FIO = lines.First(l => l.StartsWith("ФИО=")).Split('=')[1],
                            Faculty = lines.First(l => l.StartsWith("Факультет=")).Split('=')[1],
                            Position = lines.First(l => l.StartsWith("Должность=")).Split('=')[1],
                            Gender = lines.First(l => l.StartsWith("Пол=")).Split('=')[1],
                            BirthDate = DateTime.Parse(lines.First(l => l.StartsWith("ДатаРождения=")).Split('=')[1]),
                            Email = lines.First(l => l.StartsWith("Email=")).Split('=')[1],
                            Phone = lines.First(l => l.StartsWith("Телефон=")).Split('=')[1],
                            Login = lines.First(l => l.StartsWith("Логин=")).Split('=')[1],
                            Password = lines.First(l => l.StartsWith("Пароль=")).Split('=')[1],
                            AuthCode = code
                        };

                        textBox20.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\nДанные пользователя:\r\n" +
                                        string.Join("\r\n", lines);
                        found = true;
                        break;
                    }
                }

                if (!found)
                    throw new Exception("Код авторизации не найден.");
            }
            catch (Exception ex)
            {
                textBox20.Text = $"Ошибка: {ex.Message}";
            }
        }

        private void button9_Click(object sender, EventArgs e)
        {
            OpenFileDialog ofd = new OpenFileDialog();
            ofd.Filter = "Текстовые файлы (*.txt)|*.txt|Все файлы (*.*)|*.*";

            if (ofd.ShowDialog() == DialogResult.OK)
            {
                textBox21.Text = ofd.FileName;
            }
        }

        private void button8_Click(object sender, EventArgs e)
        {
            textBox22.Clear();

            try
            {
                string keyFilePath = textBox21.Text.Trim();
                if (string.IsNullOrWhiteSpace(keyFilePath))
                    throw new Exception("Файл ключа не выбран.");
                if (!File.Exists(keyFilePath))
                    throw new Exception("Файл ключа не найден.");

                string codeLine = File.ReadAllLines(keyFilePath).FirstOrDefault(l => l.StartsWith("КодАвторизации="));
                if (codeLine == null)
                    throw new Exception("В выбранном файле не найден код авторизации.");

                string code = codeLine.Split('=')[1].Trim();

                string appRootPath = Directory.GetParent(Application.StartupPath).Parent.Parent.FullName;
                string employeesFolder = Path.Combine(appRootPath, "employees");

                bool found = false;
                Employee user = null;

                foreach (string file in Directory.GetFiles(employeesFolder, "*.txt"))
                {
                    string[] lines = File.ReadAllLines(file);
                    string savedCode = lines.FirstOrDefault(l => l.StartsWith("КодАвторизации="))?.Split('=')[1];

                    if (savedCode == code)
                    {
                        user = new Employee
                        {
                            FIO = lines.First(l => l.StartsWith("ФИО=")).Split('=')[1],
                            Faculty = lines.First(l => l.StartsWith("Факультет=")).Split('=')[1],
                            Position = lines.First(l => l.StartsWith("Должность=")).Split('=')[1],
                            Gender = lines.First(l => l.StartsWith("Пол=")).Split('=')[1],
                            BirthDate = DateTime.Parse(lines.First(l => l.StartsWith("ДатаРождения=")).Split('=')[1]),
                            Email = lines.First(l => l.StartsWith("Email=")).Split('=')[1],
                            Phone = lines.First(l => l.StartsWith("Телефон=")).Split('=')[1],
                            Login = lines.First(l => l.StartsWith("Логин=")).Split('=')[1],
                            Password = lines.First(l => l.StartsWith("Пароль=")).Split('=')[1],
                            AuthCode = code
                        };

                        textBox22.Text = $"Авторизация успешна! Добро пожаловать, {user.FIO}.\r\nДанные пользователя:\r\n" +
                                        string.Join("\r\n", lines);
                        found = true;
                        break;
                    }
                }

                if (!found)
                    throw new Exception("Код авторизации из файла не найден.");
            }
            catch (Exception ex)
            {
                textBox22.Text = $"Ошибка: {ex.Message}";
            }
        }
    }
}
